import { expect, use } from 'chai'
import { Contract, BigNumber } from 'ethers'
import { deployContract, MockProvider, solidity } from 'ethereum-waffle'
import * as ReentrancyImprovedByCEIPattern from '../build/ReentrancyImprovedByCEIPattern.json'
import * as ReentrancyImprovedByMutex from '../build/ReentrancyImprovedByMutex.json'
import * as ReentrancyAttack from '../build/ReentrancyAttack.json'

use(solidity)

describe('ReentrancyImprovedByCEIPattern', () => {
  const ether = BigNumber.from(10).pow(18)
  const [walletA, walletB] = new MockProvider().getWallets()

  let reentrancy: Contract

  beforeEach(async () => {
    reentrancy = await deployContract(walletA, ReentrancyImprovedByCEIPattern)
  })

  it('should fail on attack', async () => {
    // A deposits 1 ether
    await expect(
      await reentrancy.deposit({ value: ether })
    ).to.changeEtherBalances([walletA, reentrancy], [ether.mul(-1), ether])
    expect(await reentrancy.balanceOf(walletA.address)).to.equal(ether)

    // B performs an attack
    const reentrancyAttack = await deployContract(walletB, ReentrancyAttack)
    await expect(reentrancyAttack.attack(reentrancy.address, { value: ether }))
      .to.be.reverted
  })
})

describe('ReentrancyImprovedByMutex', () => {
  const [walletA, walletB] = new MockProvider().getWallets()
  const ether = BigNumber.from(10).pow(18)
  let reentrancy: Contract

  beforeEach(async () => {
    reentrancy = await deployContract(walletA, ReentrancyImprovedByMutex)
  })

  it('should fail on attack', async () => {
    // A deposits 1 ether
    await expect(
      await reentrancy.deposit({ value: ether })
    ).to.changeEtherBalances([walletA, reentrancy], [ether.mul(-1), ether])
    expect(await reentrancy.balanceOf(walletA.address)).to.equal(ether)

    // B performs an attack
    const reentrancyAttack = await deployContract(walletB, ReentrancyAttack)
    await expect(reentrancyAttack.attack(reentrancy.address, { value: ether }))
      .to.be.reverted
  })
})
