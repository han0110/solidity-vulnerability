import { expect, use } from 'chai'
import { Contract, BigNumber } from 'ethers'
import { deployContract, MockProvider, solidity } from 'ethereum-waffle'
import * as Reentrancy from '../build/Reentrancy.json'
import * as ReentrancyAttack from '../build/ReentrancyAttack.json'

use(solidity)

describe('Reentrancy', () => {
  const ether = BigNumber.from(10).pow(18)
  const [walletA, walletB] = new MockProvider().getWallets()

  let reentrancy: Contract

  beforeEach(async () => {
    reentrancy = await deployContract(walletA, Reentrancy)
  })

  it('should attack', async () => {
    // A deposits 1 ether
    await expect(
      await reentrancy.deposit({ value: ether })
    ).to.changeEtherBalances([walletA, reentrancy], [ether.mul(-1), ether])
    expect(await reentrancy.balanceOf(walletA.address)).to.equal(ether)

    // B performs an attack
    const reentrancyAttack = await deployContract(walletB, ReentrancyAttack)
    await expect(
      await reentrancyAttack.attack(reentrancy.address, { value: ether })
    ).to.changeEtherBalances(
      [reentrancyAttack, reentrancy],
      [
        // A + B
        ether.mul(2),
        // A's balance
        ether.mul(-1),
      ]
    )
  })
})
